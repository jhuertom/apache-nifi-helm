{{- if .Values.global.ldap.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "nifi.fullname" . }}-ldap-admin-setup
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "nifi.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: 10
  template:
    metadata:
      labels:
        app: {{ include "nifi.name" . }}-ldap-setup
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "nifi.serviceAccountName" . }}
      containers:
      - name: setup-ldap-admin
        image: alpine/k8s:1.28.0
        command:
        - sh
        - -c
        - |
          set -e
          
          echo "Waiting for NiFi to be ready..."
          until curl -k -s https://{{ include "nifi.fullname" . }}-0.{{ include "nifi.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local:8443/nifi-api/flow/status > /dev/null 2>&1; do
            echo "NiFi not ready yet, waiting..."
            sleep 10
          done
          
          echo "NiFi is ready. Setting up LDAP admin {{ .Values.global.ldap.initialAdminIdentity }}..."
          
          # Check if user exists
          if kubectl exec {{ include "nifi.fullname" . }}-0 -n {{ .Release.Namespace }} -- \
            grep -q "identity=\"{{ .Values.global.ldap.initialAdminIdentity }}\"" \
            /opt/nifi/nifi-current/persistent_conf/users.xml 2>/dev/null; then
            
            echo "User {{ .Values.global.ldap.initialAdminIdentity }} found in users.xml"
            
            # Get the user UUID
            USER_ID=$(kubectl exec {{ include "nifi.fullname" . }}-0 -n {{ .Release.Namespace }} -- \
              grep "identity=\"{{ .Values.global.ldap.initialAdminIdentity }}\"" \
              /opt/nifi/nifi-current/persistent_conf/users.xml | \
              sed -n 's/.*identifier="\([^"]*\)".*/\1/p' | head -1)
            
            echo "User UUID: $USER_ID"
            
            # Get Root Process Group UUID (using kubectl from Job pod)
            ROOT_GROUP_ID=$(kubectl exec {{ include "nifi.fullname" . }}-0 -n {{ .Release.Namespace }} -- \
              sh -c "zcat /opt/nifi/nifi-current/persistent_conf/flow.json.gz | jq -r .rootGroup.identifier")
            
            echo "Root Group ID: $ROOT_GROUP_ID"
              
            if [ -n "$USER_ID" ]; then
              echo "Adding admin policies for user $USER_ID..."
                
                # Create script to add policies
                kubectl exec {{ include "nifi.fullname" . }}-0 -n {{ .Release.Namespace }} -- bash -c "
                kubectl exec {{ include "nifi.fullname" . }}-0 -n {{ .Release.Namespace }} -- bash -c "
                  USER_ID='$USER_ID'
                  ROOT_GROUP_ID='$ROOT_GROUP_ID'
                  AUTH_FILE='/opt/nifi/nifi-current/persistent_conf/authorizations.xml'
                  
                  # Backup original file
                  cp \"\$AUTH_FILE\" \"\${AUTH_FILE}.backup\"
                  
                  # Function to add user to policy
                  add_user_to_policy() {
                    RESOURCE=\$1
                    ACTION=\$2
                    
                    # Check if policy exists
                    if grep -q \"resource=\\\"\$RESOURCE\\\".*action=\\\"\$ACTION\\\"\" \"\$AUTH_FILE\"; then
                      # Add user to existing policy if not already there
                      if ! grep -A 10 \"resource=\\\"\$RESOURCE\\\".*action=\\\"\$ACTION\\\"\" \"\$AUTH_FILE\" | grep -q \"identifier=\\\"\$USER_ID\\\"\"; then
                        sed -i \"/resource=\\\"\$RESOURCE\\\".*action=\\\"\$ACTION\\\"/,/<\/policy>/ s|</policy>|      <user identifier=\\\"\$USER_ID\\\"/>\\\n    </policy>|\" \"\$AUTH_FILE\"
                        echo \"Added user to \$RESOURCE \$ACTION policy\"
                      fi
                    else
                      # Create new policy
                      POLICY_ID=\$(cat /proc/sys/kernel/random/uuid)
                      sed -i \"/<\/policies>/i\    <policy action=\\\"\$ACTION\\\" identifier=\\\"\$POLICY_ID\\\" resource=\\\"\$RESOURCE\\\">\\\n      <user identifier=\\\"\$USER_ID\\\"/>\\\n    </policy>\" \"\$AUTH_FILE\"
                      echo \"Created new \$RESOURCE \$ACTION policy\"
                    fi
                  }
                  
                  # Add all admin policies
                  add_user_to_policy '/flow' 'R'
                  add_user_to_policy '/flow' 'W'
                  add_user_to_policy '/controller' 'R'
                  add_user_to_policy '/controller' 'W'
                  add_user_to_policy '/policies' 'R'
                  add_user_to_policy '/policies' 'W'
                  add_user_to_policy '/tenants' 'R'
                  add_user_to_policy '/tenants' 'W'
                  add_user_to_policy '/restricted-components' 'W'
                  add_user_to_policy '/provenance' 'R'
                  # Root Process Group UUID passed from Job pod
                  # ROOT_GROUP_ID already set
                  
                  if [ -n "$ROOT_GROUP_ID" ] && [ "$ROOT_GROUP_ID" != "null" ]; then
                    add_user_to_policy "/process-groups/$ROOT_GROUP_ID" 'R'
                    add_user_to_policy "/process-groups/$ROOT_GROUP_ID" 'W'
                    add_user_to_policy "/data/process-groups/$ROOT_GROUP_ID" 'R'
                    add_user_to_policy "/data/process-groups/$ROOT_GROUP_ID" 'W'
                  fi

                  add_user_to_policy '/process-groups/root' 'R'
                  add_user_to_policy '/process-groups/root' 'W'
                  add_user_to_policy '/system' 'R'
                  
                  echo 'Admin policies added successfully'
                "
                
                # Copy policies to other nodes
                echo "Syncing policies to other nodes..."
                for pod in {{ include "nifi.fullname" . }}-1 {{ include "nifi.fullname" . }}-2; do
                  kubectl exec {{ include "nifi.fullname" . }}-0 -n {{ .Release.Namespace }} -- \
                    cat /opt/nifi/nifi-current/persistent_conf/authorizations.xml | \
                    kubectl exec -i $pod -n {{ .Release.Namespace }} -- \
                    tee /opt/nifi/nifi-current/persistent_conf/authorizations.xml > /dev/null
                  echo "Synced to $pod"
                done
              
              echo "=========================================="
              echo "LDAP admin setup completed successfully!"
              echo "User: {{ .Values.global.ldap.initialAdminIdentity }}"
              echo "Please refresh your NiFi UI (F5)"
              echo "=========================================="
            else
              echo "ERROR: Could not find user UUID"
              exit 1
            fi
          else
            echo "ERROR: User {{ .Values.global.ldap.initialAdminIdentity }} not found in users.xml"
            echo "Please ensure the user is configured in authorizers.xml"
            exit 1
          fi
{{- end }}
